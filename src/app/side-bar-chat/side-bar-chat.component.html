<button *ngIf="!isOpen && userId" (click)="toggleChat()" class="fixed top-[16px] right-[220px] z-50">
  <img
    class="h-9 w-9 p-1 rounded-full hover:scale-110 transition-transform duration-200 cursor-pointer"
    src="https://img.icons8.com/?size=100&id=20383&format=png&color=ffffff"
    alt="Chat Icon"
  />
</button>
<div *ngIf="isOpen" class="fixed inset-0 z-50 bg-black/50" (click)="toggleChat()">
  <div
    class="absolute right-0 bg-[#121212] rounded-none shadow-2xl w-[30%] h-full transition-all duration-300 transform scale-100 opacity-100 translate-y-0"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="bg-gradient-to-r from-black to-green-600 text-white px-4 py-3 flex justify-between items-center h-14">
      <span class="font-sans font-semibold text-base">Messages & Contacts</span>
      <button
        (click)="toggleChat()"
        class="w-8 h-8 flex items-center justify-center rounded-full text-xl font-bold hover:bg-[#282828] transition-colors"
      >
        Ã—
      </button>
    </div>

    <div class="px-4 py-2">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (input)="handleSearchChange($event)"
        placeholder="Search users and conversations..."
        class="w-full p-2 bg-[#282828] text-white border border-[#3E3E3E] rounded-full focus:outline-none focus:ring-2 focus:ring-[#1DB954] text-sm font-sans transition-all"
      />
    </div>

    <!-- Conversation list -->
    <div class="overflow-y-auto" style="height: calc(100% - 112px);">
      <!-- Empty state -->
      <div *ngIf="filteredConversations.length === 0" class="flex flex-col items-center justify-center h-32">
        <p class="text-gray-400 text-sm">No users or conversations found</p>
      </div>
      
      <!-- Recent Chats Section -->
      <div *ngIf="hasExistingConversations()" class="px-4 pt-4 pb-2">
        <h3 class="text-xs uppercase text-gray-500 font-semibold tracking-wider">Recent Conversations</h3>
      </div>
      
      <!-- Existing Conversations -->
      <div
        *ngFor="let conversation of filteredConversations"
        (click)="selectConversation(conversation)"
        class="flex items-center px-4 py-3 hover:bg-[#282828] cursor-pointer transition-all duration-200"
        [ngClass]="{'bg-[#1DB95420]': conversation.unread}"
      >
        <!-- Profile picture -->
        <div class="relative">
          <img
            *ngIf="conversation.profilePicture"
            [src]="conversation.profilePicture"
            class="w-12 h-12 rounded-full mr-3"
            alt="{{ conversation.name }}"
            (error)="handleImageError($event)"
          />
          <div
            *ngIf="!conversation.profilePicture"
            class="w-12 h-12 rounded-full mr-3 bg-[#3E3E3E] flex items-center justify-center text-white text-lg font-sans"
          >
            {{ conversation.name.charAt(0).toUpperCase() }}
          </div>
          <!-- Unread indicator -->
          <div
            *ngIf="conversation.unread"
            class="absolute bottom-0 right-3 w-4 h-4 bg-[#1DB954] rounded-full border-2 border-[#121212]"
          ></div>
        </div>

        <!-- Conversation info -->
        <div class="flex-1 min-w-0">
          <div class="flex justify-between items-baseline">
            <span 
              class="font-sans truncate"
              [ngClass]="{'font-semibold text-white': conversation.unread, 'text-gray-300': !conversation.unread}"
            >
              {{ conversation.name }}
            </span>
            <span class="text-xs font-sans text-[#B3B3B3] ml-2 whitespace-nowrap">
              {{ formatTime(conversation.timestamp) }}
            </span>
          </div>
          <div 
            class="text-sm font-sans truncate"
            [ngClass]="{'text-gray-300': conversation.unread, 'text-[#B3B3B3]': !conversation.unread}"
          >
            <!-- Show appropriate message for new vs existing conversations -->
            <span *ngIf="isNewConversation(conversation)" class="text-[#1DB954]">
              Start a new conversation
            </span>
            <span *ngIf="!isNewConversation(conversation)">
              {{ conversation.lastMessage }}
            </span>
          </div>
        </div>
      </div>
      <div #conversationsEnd></div>
    </div>
  </div>
</div>